//@version=5
strategy("Advanced Volume & Price Action Strategy - Multi-Session", 
         overlay=true, 
         initial_capital=5000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=2,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=3)

// ============================================================================
// STRATEGY PARAMETERS
// ============================================================================

// Risk Management
riskPerTrade = input.float(2.0, "Risk Per Trade (%)", minval=0.5, maxval=5.0, group="Risk Management")
riskRewardRatio = input.float(2.5, "Risk:Reward Ratio", minval=1.5, maxval=5.0, group="Risk Management")
maxDailyLoss = input.float(6.0, "Max Daily Loss (%)", minval=2.0, maxval=10.0, group="Risk Management")
useTrailingStop = input.bool(true, "Use Trailing Stop", group="Risk Management")
trailingStopPercent = input.float(1.5, "Trailing Stop (%)", minval=0.5, maxval=5.0, group="Risk Management")

// Session Settings
londonSession = input.bool(true, "Trade London Session", group="Trading Sessions")
newYorkSession = input.bool(true, "Trade New York Session", group="Trading Sessions")
tokyoSession = input.bool(true, "Trade Tokyo Session", group="Trading Sessions")

// Volume Settings
volumeMALength = input.int(20, "Volume MA Length", minval=5, maxval=100, group="Volume Analysis")
volumeThreshold = input.float(1.5, "Volume Spike Threshold", minval=1.0, maxval=3.0, group="Volume Analysis")
useVolumeConfirmation = input.bool(true, "Require Volume Confirmation", group="Volume Analysis")

// Price Action Settings
swingLookback = input.int(10, "Swing High/Low Lookback", minval=5, maxval=50, group="Price Action")
engulfingMinSize = input.float(0.5, "Min Engulfing Size (%)", minval=0.1, maxval=2.0, group="Price Action")
pinbarWickRatio = input.float(2.0, "Pinbar Wick Ratio", minval=1.5, maxval=4.0, group="Price Action")

// Key Level Settings
showMidday = input.bool(true, "Show Midday Levels", group="Key Levels")
showClose = input.bool(true, "Show Close Levels", group="Key Levels")
levelLookback = input.int(2, "Days to Look Back", minval=1, maxval=5, group="Key Levels")

// ============================================================================
// SESSION DETECTION
// ============================================================================

// Tokyo Session: 00:00 - 09:00 UTC
tokyoSessionTime = (hour >= 0 and hour < 9)

// London Session: 08:00 - 16:00 UTC
londonSessionTime = (hour >= 8 and hour < 16)

// New York Session: 13:00 - 21:00 UTC
newYorkSessionTime = (hour >= 13 and hour < 21)

// Active session check
activeSession = (tokyoSession and tokyoSessionTime) or 
                (londonSession and londonSessionTime) or 
                (newYorkSession and newYorkSessionTime)

// ============================================================================
// KEY LEVEL CALCULATIONS (MIDDAY & CLOSE)
// ============================================================================

// Get midday price (12:00 UTC)
var float[] middayLevels = array.new_float(0)
var float[] closeLevels = array.new_float(0)

// Detect midday (12:00)
isMidday = hour == 12 and minute == 0
if isMidday
    array.unshift(middayLevels, close)
    if array.size(middayLevels) > levelLookback
        array.pop(middayLevels)

// Detect daily close (23:59 or new day)
isNewDay = ta.change(dayofmonth) != 0
if isNewDay
    array.unshift(closeLevels, close[1])
    if array.size(closeLevels) > levelLookback
        array.pop(closeLevels)

// Plot midday levels
if showMidday and array.size(middayLevels) > 0
    for i = 0 to math.min(array.size(middayLevels) - 1, levelLookback - 1)
        line.new(bar_index - 1, array.get(middayLevels, i), bar_index, array.get(middayLevels, i), 
                 color=color.new(color.yellow, 50), style=line.style_dashed, width=1)

// Plot close levels
if showClose and array.size(closeLevels) > 0
    for i = 0 to math.min(array.size(closeLevels) - 1, levelLookback - 1)
        line.new(bar_index - 1, array.get(closeLevels, i), bar_index, array.get(closeLevels, i), 
                 color=color.new(color.blue, 50), style=line.style_solid, width=2)

// ============================================================================
// VOLUME ANALYSIS
// ============================================================================

volumeMA = ta.sma(volume, volumeMALength)
volumeSpike = volume > (volumeMA * volumeThreshold)
volumeIncreasing = volume > volume[1] and volume[1] > volume[2]

// Volume confirmation
volumeConfirmed = useVolumeConfirmation ? volumeSpike or volumeIncreasing : true

// Plot volume indicators
plot(volumeMA, "Volume MA", color=color.new(color.gray, 70), display=display.none)
bgcolor(volumeSpike ? color.new(color.purple, 90) : na, title="Volume Spike")

// ============================================================================
// PRICE ACTION PATTERNS
// ============================================================================

// Candle measurements
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
candleRange = high - low

// Bullish Engulfing
bullishEngulfing = close > open and 
                   close[1] < open[1] and 
                   open <= close[1] and 
                   close >= open[1] and
                   bodySize > (candleRange * engulfingMinSize / 100)

// Bearish Engulfing
bearishEngulfing = close < open and 
                   close[1] > open[1] and 
                   open >= close[1] and 
                   close <= open[1] and
                   bodySize > (candleRange * engulfingMinSize / 100)

// Bullish Pinbar
bullishPinbar = lowerWick > (bodySize * pinbarWickRatio) and 
                upperWick < bodySize and 
                close > open

// Bearish Pinbar
bearishPinbar = upperWick > (bodySize * pinbarWickRatio) and 
                lowerWick < bodySize and 
                close < open

// Inside Bar
insideBar = high < high[1] and low > low[1]

// Swing High/Low
swingHigh = ta.highest(high, swingLookback)
swingLow = ta.lowest(low, swingLookback)

// Support/Resistance breaks
breakoutAbove = close > swingHigh[1] and close[1] <= swingHigh[1]
breakoutBelow = close < swingLow[1] and close[1] >= swingLow[1]

// ============================================================================
// KEY LEVEL INTERACTION
// ============================================================================

// Check if price is near key levels
var float tolerance = 0.002 // 0.2% tolerance

nearMidday = false
nearClose = false

if array.size(middayLevels) > 0
    for i = 0 to array.size(middayLevels) - 1
        level = array.get(middayLevels, i)
        if math.abs(close - level) / level < tolerance
            nearMidday := true

if array.size(closeLevels) > 0
    for i = 0 to array.size(closeLevels) - 1
        level = array.get(closeLevels, i)
        if math.abs(close - level) / level < tolerance
            nearClose := true

// Bounce from key levels
bouncedFromSupport = (nearMidday or nearClose) and low <= math.min(array.size(middayLevels) > 0 ? array.get(middayLevels, 0) : high, array.size(closeLevels) > 0 ? array.get(closeLevels, 0) : high) and close > open
bouncedFromResistance = (nearMidday or nearClose) and high >= math.max(array.size(middayLevels) > 0 ? array.get(middayLevels, 0) : low, array.size(closeLevels) > 0 ? array.get(closeLevels, 0) : low) and close < open

// ============================================================================
// TREND ANALYSIS
// ============================================================================

ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)

uptrend = ema20 > ema50 and ema50 > ema200
downtrend = ema20 < ema50 and ema50 < ema200

plot(ema20, "EMA 20", color=color.new(color.green, 0), linewidth=1)
plot(ema50, "EMA 50", color=color.new(color.orange, 0), linewidth=1)
plot(ema200, "EMA 200", color=color.new(color.red, 0), linewidth=2)

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================

// Long Entry Conditions
longCondition1 = bullishEngulfing and volumeConfirmed and (uptrend or bouncedFromSupport)
longCondition2 = bullishPinbar and volumeConfirmed and low <= swingLow and close > ema20
longCondition3 = breakoutAbove and volumeSpike and uptrend
longCondition4 = bouncedFromSupport and volumeConfirmed and close > ema20

longSignal = (longCondition1 or longCondition2 or longCondition3 or longCondition4) and activeSession

// Short Entry Conditions
shortCondition1 = bearishEngulfing and volumeConfirmed and (downtrend or bouncedFromResistance)
shortCondition2 = bearishPinbar and volumeConfirmed and high >= swingHigh and close < ema20
shortCondition3 = breakoutBelow and volumeSpike and downtrend
shortCondition4 = bouncedFromResistance and volumeConfirmed and close < ema20

shortSignal = (shortCondition1 or shortCondition2 or shortCondition3 or shortCondition4) and activeSession

// ============================================================================
// RISK MANAGEMENT & POSITION SIZING
// ============================================================================

// Calculate position size based on risk
accountSize = strategy.equity
riskAmount = accountSize * (riskPerTrade / 100)

// Stop loss calculation
longStopLoss = ta.lowest(low, 5)
shortStopLoss = ta.highest(high, 5)

longStopDistance = close - longStopLoss
shortStopDistance = shortStopLoss - close

// Take profit calculation
longTakeProfit = close + (longStopDistance * riskRewardRatio)
shortTakeProfit = close - (shortStopDistance * riskRewardRatio)

// Daily loss tracking
var float dailyPnL = 0.0
var int lastDay = 0

if dayofmonth != lastDay
    dailyPnL := 0.0
    lastDay := dayofmonth

// Update daily PnL
if strategy.closedtrades > 0
    dailyPnL := strategy.netprofit - strategy.netprofit[1]

// Check if max daily loss reached
maxDailyLossReached = dailyPnL < -(accountSize * maxDailyLoss / 100)

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Long Entry
if longSignal and not maxDailyLossReached and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", 
                  stop=longStopLoss, 
                  limit=longTakeProfit,
                  trail_price=useTrailingStop ? longTakeProfit : na,
                  trail_offset=useTrailingStop ? close * (trailingStopPercent / 100) : na)

// Short Entry
if shortSignal and not maxDailyLossReached and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", 
                  stop=shortStopLoss, 
                  limit=shortTakeProfit,
                  trail_price=useTrailingStop ? shortTakeProfit : na,
                  trail_offset=useTrailingStop ? close * (trailingStopPercent / 100) : na)

// ============================================================================
// VISUAL SIGNALS
// ============================================================================

plotshape(longSignal, "Long Signal", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(shortSignal, "Short Signal", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

// Session background
bgcolor(tokyoSessionTime and tokyoSession ? color.new(color.yellow, 95) : na, title="Tokyo Session")
bgcolor(londonSessionTime and londonSession ? color.new(color.blue, 95) : na, title="London Session")
bgcolor(newYorkSessionTime and newYorkSession ? color.new(color.green, 95) : na, title="New York Session")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(longSignal, "Long Entry Signal", "Long entry opportunity detected!")
alertcondition(shortSignal, "Short Entry Signal", "Short entry opportunity detected!")
alertcondition(maxDailyLossReached, "Max Daily Loss", "Maximum daily loss reached - stop trading!")
