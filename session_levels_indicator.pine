// @version=6
indicator("Session Levels Indicator", shorttitle="SessLevels", overlay=true, max_lines_count=50, max_labels_count=50)

// === INPUTS ===
session_time = input.session("0930-1600", title="Session Time")
lookback_days = input.int(2, title="Lookback Days", minval=1, maxval=10)

// === SIMPLIFIED SESSION DATA FUNCTION ===
get_session_data(session_spec, days_back) =>
    var float s_high = na
    var float s_low = na
    var float s_close = na
    
    in_sess = time(timeframe.period, session_spec)
    sess_start = not in_sess[1] and in_sess
    sess_end = in_sess[1] and not in_sess
    
    if sess_start
        s_high := high
        s_low := low
        s_close := na
    
    if in_sess
        s_high := math.max(nz(s_high), high)
        s_low := math.min(nz(s_low, s_low), low)
        s_close := close
    
    if sess_end
        s_close := close[1]
    
    [s_high, s_low, s_close]

// === GLOBAL VARIABLES ===
var midpoint_lines = array.new<line>()
var close_lines = array.new<line>()
var midpoint_labels = array.new<label>()
var close_labels = array.new<label>()

// === CLEANUP PREVIOUS DRAWINGS ===
if barstate.islast
    if array.size(midpoint_lines) > 0
        for i = 0 to array.size(midpoint_lines) - 1
            line.delete(array.get(midpoint_lines, i))
        array.clear(midpoint_lines)
    
    if array.size(close_lines) > 0
        for i = 0 to array.size(close_lines) - 1
            line.delete(array.get(close_lines, i))
        array.clear(close_lines)
    
    if array.size(midpoint_labels) > 0
        for i = 0 to array.size(midpoint_labels) - 1
            label.delete(array.get(midpoint_labels, i))
        array.clear(midpoint_labels)
    
    if array.size(close_labels) > 0
        for i = 0 to array.size(close_labels) - 1
            label.delete(array.get(close_labels, i))
        array.clear(close_labels)

// === CALCULATE AND PLOT LEVELS ===
if barstate.islast
    for i = 1 to lookback_days
        [s_high, s_low, s_close] = get_session_data(session_time, i)
        
        if not na(s_high) and not na(s_low)
            midpoint = (s_high + s_low) / 2
            current_bar = bar_index
            future_bar = current_bar + 100
            
            mid_line = line.new(current_bar, midpoint, future_bar, midpoint, color=color.new(color.blue, 80), style=line.style_solid, width=1, extend=extend.right)
            array.push(midpoint_lines, mid_line)
            
            mid_label = label.new(current_bar, midpoint, "Mid D-" + str.tostring(i), color=color.new(color.blue, 90), textcolor=color.white, style=label.style_label_right, size=size.small)
            array.push(midpoint_labels, mid_label)
            
            if not na(s_close)
                cl_line = line.new(current_bar, s_close, future_bar, s_close, color=color.new(color.red, 80), style=line.style_solid, width=1, extend=extend.right)
                array.push(close_lines, cl_line)
                
                cl_label = label.new(current_bar, s_close, "Close D-" + str.tostring(i), color=color.new(color.red, 90), textcolor=color.white, style=label.style_label_right, size=size.small)
                array.push(close_labels, cl_label)

// === BACKGROUND HIGHLIGHTING ===
in_current_session = time(timeframe.period, session_time)
var color bg_color = na
bg_color := in_current_session ? color.new(color.gray, 95) : na
bgcolor(bg_color, title="Session Background")

// === ALERTS ===
[y_high, y_low, y_close] = get_session_data(session_time, 1)
y_midpoint = not na(y_high) and not na(y_low) ? (y_high + y_low) / 2 : na

crossover_mid = ta.crossover(close, y_midpoint)
crossunder_mid = ta.crossunder(close, y_midpoint)
crossover_close = ta.crossover(close, y_close)
crossunder_close = ta.crossunder(close, y_close)

mid_cross_up = not na(y_midpoint) and crossover_mid
mid_cross_down = not na(y_midpoint) and crossunder_mid
close_cross_up = not na(y_close) and crossover_close
close_cross_down = not na(y_close) and crossunder_close

alertcondition(mid_cross_up or mid_cross_down, title="Midpoint Level Cross", message="Price crossed yesterday's midpoint level")
alertcondition(close_cross_up or close_cross_down, title="Close Level Cross", message="Price crossed yesterday's close level")

// === PLOTS FOR REFERENCE ===
plot(not na(y_midpoint) ? y_midpoint : na, title="Yesterday Midpoint", color=color.new(color.blue, 50), linewidth=1, display=display.none)
plot(not na(y_close) ? y_close : na, title="Yesterday Close", color=color.new(color.red, 50), linewidth=1, display=display.none)

// === DEBUG INFO ===
var label debug_label = na
if barstate.islast
    debug_text = "Levels: " + str.tostring(lookback_days) + " days"
    if na(debug_label)
        debug_label := label.new(bar_index, high, debug_text, color=color.new(color.purple, 90), textcolor=color.white, style=label.style_label_down, size=size.small)
    else
        label.set_xy(debug_label, bar_index, high)
        label.set_text(debug_label, debug_text)
